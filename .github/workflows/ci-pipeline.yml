
name: CI pipeline

# reusable workflow to be called from other workflow



on:
  workflow_call:
   inputs:
     run_unit_tests:
     description: "Run Unit Tests"
     required: false
     default: true
     type: boolean

     run_build:
       description: "Create Application Image"
       required: false
       default: true
       type: boolean
       
     run_codeql:
       description: "Run Codeql scan"
       required: false
       default: true
       type: boolean
       
     run_sonarqube:
       description: "Run SonarQube scan"
       required: false
       default: true
       type: boolean   
     
    secrets:
      SONAR_TOKEN:
        required: true
        
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_ACCESS_TOKEN:
        required: true
        
jobs:
  unit-tests:
    if: ${{ inputs.run_unit_tests }}
    name: running unit tests
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v6.0.2
      - name: Setup Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: '3.10'
      - name: Install Dependencies    
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt


      - name: Run Unit Tests
        run: |
          mkdir report/
          pytest --junitxml=reports/unit-test-results.xml --cov=. --cov-report=xml:reports/coverage.xml --cov-report=term-missing -v
      - name: upload code coverage report
        uses: actions/upload-artifact@v5.0.0
        with:
          name: unit-test-report
          path: reports/
  codeql: 
   if: ${{ inputs.run_codeql }}
   name: CodeQl security scan
   runs-on: ubuntu-latest
   permissions:
     actions: read
     contents: read        
     security-events: write
   strategy:
     matrix:
       language: ['python']
   steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2   
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
      - name: perform CodeQL analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "security" 
  
  sonarqube:
    if: ${{ inputs.run_sonarqube }}
    name: SonarQube
    needs: unit-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0  # Shallow clones  should be disabled for a better relevancy of analysis
      - name: download coverage report
        uses: actions/download-artifact@v5.0.0
        with:
          name: unit-test-report
          path: reports/
      - name: SonarQube Scan
        uses: SonarSource/sonarcloud-github-action@v2   
        env:
         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  build:
    if: ${{ success() && inputs.run_build }}
    name: Build Image
    runs-on: ubuntu-latest
    needs: [unit-tests, sonarqube, codeql]
    outputs: 
      image-tag : ${{ steps.vars.outputs.IMAGE_TAGS }}
    steps:
      - name: checkout code
        uses: actions/checkout@v6.0.2
      - name: setup docker buildx
        uses: docker/setup-buildx-action@v3.0.0
      - name: generate image tag
        id: vars
        run: |
           IMAGE_TAGS="${{ github.run_id }}-${GITHUB_SHA::7}"
            echo "IMAGE_TAGS=$IMAGE_TAGS" >> $GITHUB_OUTPUT
      - name: build Image (no push)
        uses: docker/build-push-action@v3.0.0
        with:
          context: .
          file: ./Dockerfile
          tags: thinknyx-app:${{ steps.vars.outputs.IMAGE_TAGS }}
          push: false
          load: true      
      - name: save docker iamge
        run: docker save thinknyx-app:${{ steps.vars.outputs.IMAGE_TAGS }} -o thinknyx-app.tar    
      - name: upload docker image
        uses: actions/upload-artifact@v5.0.0
        with: 
          name: thinknyx-app-image
          path: thinknyx-app.tar 
  publish-Dockerhub:
      if: ${{ inputs.run_dockerhub_publish }}
      name: publish to dockerhub
      runs-on: ubuntu-latest
      needs: build
      steps:
        - name: download docker image
          uses: actions/download-artifact@v5.0.0
          with:
            name: thinknyx-app-image
            path: .

        - name: load docker image
          run: docker load -i thinknyx-app.tar

        - name: login dockerhub
          uses: docker/login-action@v3.0.0
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}
        - name: tage docker image
          run: |
           IMAGE_TAGS=${{ needs.build.outputs.image-tag }}
            docker image tag thinknyx-app:${IMAGE_TAGS} ${{ secrets.DOCKERHUB_USERNAME }}/thinknyx-app:${IMAGE_TAGS}
        - name: push docker image  
          run: |
           IMAGE_TAGS=${{ needs.build.outputs.image-tag }}
            docker push ${{ secrets.DOCKERHUB_USERNAME }}/thinknyx-app:${IMAGE_TAGS}
